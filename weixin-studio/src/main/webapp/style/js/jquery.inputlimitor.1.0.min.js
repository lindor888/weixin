
function CharacterLen(str){  
    var len = 0;  
    for (var i=0; i<str.length; i++) {   
      var c = str.charCodeAt(i);   
     //单字节加1   
      if ((c >= 0x0001 && c <= 0x007e) || (0xff60<=c && c<=0xff9f)) {   
        len++;   
      }else{   
       len+=2;   
      }   
     }
     return len/2;
}

function SubCharacter(src,s,e){
	var len = 0;  
	var i = 0;
    for (i=0; i<src.length; i++) {   
      var c = src.charCodeAt(i);   
     //单字节加1   
      if ((c >= 0x0001 && c <= 0x007e) || (0xff60<=c && c<=0xff9f)) {   
        len++;   
      }else{   
       len+=2;   
      }   
      if((len/2)>e){
      	return src.substring(s,i);
      }
    }	
	return src.substring(s,i);// + "<!--"+ i + " - " + len +"-->";
}


(function ($) {
	$.fn.inputlimitor = function (options) {
		var opts = $.extend({}, $.fn.inputlimitor.defaults, options);
		if (opts.boxAttach && !$("#" + opts.boxId).length) {
			$("<div/>").appendTo("body").attr({id:opts.boxId, "class":opts.boxClass}).css({"position":"absolute"}).hide();
			if ($.fn.bgiframe) {
				$("#" + opts.boxId).bgiframe();
			}
		}
		$(this).each(function (i) {
			$(this).keyup(function (e) {
				if ($(this).val().length > opts.limit) {//--
					$(this).val($(this).val().substring(0, opts.limit));
				}
				if (opts.boxAttach) {
					$("#" + opts.boxId).css({"width":$(this).outerWidth() - ($("#" + opts.boxId).outerWidth() - $("#" + opts.boxId).width()) + "px", "left":$(this).offset().left + "px", "top":($(this).offset().top + $(this).outerHeight()) - 1 + "px"});
				}
				var remText = opts.remText;
				remText = remText.replace(/\%n/g, CharacterLen($(this).val()));
				//remText = remText.replace(/\%s/g, (opts.limit - CharacterLen($(this).val()) == 1 ? "" : "s"));
				remText = remText.replace(/\%c/g, $(this).val().length);
				var limitText = opts.limitText;
				limitText = limitText.replace(/\%n/g, opts.limit);
				limitText = limitText.replace(/\%s/g, (opts.limit == 1 ? "" : "s"));
				if (opts.limitTextShow) {
					$("#" + opts.boxId).html(remText + " " + limitText);
					var textWidth = $("<span/>").appendTo("body").attr({id:"19cc9195583bfae1fad88e19d443be7a", "class":opts.boxClass}).html(remText + " " + limitText).innerWidth();
					$("#19cc9195583bfae1fad88e19d443be7a").remove();
					if (textWidth > $("#" + opts.boxId).innerWidth()) {
						$("#" + opts.boxId).html(remText + "<br />" + limitText);
					}
					$("#" + opts.boxId).show();
				} else {
					$("#" + opts.boxId).html(remText).show();
				}
			});
			$(this).keypress(function (e) {
				if ((!e.keyCode || (e.keyCode > 46 && e.keyCode < 90)) && (CharacterLen($(this).val().length) >= opts.limit)) {
					return false;
				}
			});
			$(this).blur(function () {
				if (opts.boxAttach) {
					$("#" + opts.boxId).fadeOut("fast");
				} else {
					if (opts.remTextHideOnBlur) {
						var limitText = opts.limitText;
						limitText = limitText.replace(/\%n/g, opts.limit);
						limitText = limitText.replace(/\%s/g, (opts.limit == 1 ? "" : "s"));
						$("#" + opts.boxId).html(limitText);
					}
				}
			});
		});
	};
	$.fn.inputlimitor.defaults = {limit:255, boxAttach:true, boxId:"limitorBox", boxClass:"limitorBox", remText:"%n character%s remaining.", remTextHideOnBlur:true, limitTextShow:true, limitText:"Field limited to %n character%s."};
})(jQuery);

